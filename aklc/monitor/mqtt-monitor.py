import django
import sys
import os
from django.conf import settings
import logging
import paho.mqtt.client as mqtt
import paho.mqtt.publish as publish
import json
import datetime
import time
from django.utils import timezone
#timezone.make_aware(yourdate, timezone.get_current_timezone())

sys.path.append("/code/aklc")
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "aklc.settings")

django.setup()

from monitor.models import Node

# ********************************************************************
def mqtt_on_connect(client, userdata, flags, rc):
    """
      This procedure is called on connection to the mqtt broker
    """
    #global nodes_config
    
    print("Connected to mqtt with result code "+str(rc))
    logging.info("Connected to mqtt server")
    sub_topic = "AKLC/#"
    client.subscribe(sub_topic)
    logging.info("mqtt Subscribed to " + sub_topic)
    print("mqtt Subscribed to " + sub_topic)
    
#********************************************************************
def mqtt_on_message(client, userdata, msg):
    """This procedure is called each time a mqtt message is received"""

    print("mqtt message received {} : {}".format(msg.topic, msg.payload))

    #separate the topic up so we can work with it
    cTopic = msg.topic.split("/")
    cDict = {}            

    # Check for nodes using regular topic structure
    if cTopic[0] == "AKLC":
        
        # Check types of message from the topic
        if cTopic[1] == "Gateway":      # These are messages from nodes sent on by a gateway
          cPayload = msg.payload.split(",")   # the payload should be CSV
          #print(cPayload[1])

          if node_validate(cPayload[1]):
              nd, created = Node.objects.get_or_create(nodeID = cPayload[1])
                        
              nd.lastseen = timezone.make_aware(datetime.datetime.now(), timezone.get_current_timezone())
              nd.status = "Online"
              nd.save()
          # Check and update the gateways info
          if node_validate(cPayload[0]):
              gw, created = Node.objects.get_or_create(nodeID = cPayload[0])
                        
              gw.lastseen = timezone.make_aware(datetime.datetime.now(), timezone.get_current_timezone())
              gw.isGateway = True
              gw.status = "Online"
              gw.save()
              
              
        if cTopic[1] == "Status":      # These are status messages sent by gateways. Data in CSV format
          cPayload = msg.payload.split(",")   
          # Check and update the gateways dictionary
          if node_validate(cPayload[0]):
              gw, created = Node.objects.get_or_create(nodeID = cPayload[0])
                        
              gw.lastseen = timezone.make_aware(datetime.datetime.now(), timezone.get_current_timezone())
              gw.isGateway = True
              gw.status = "Online"
              gw.save()
              

        if cTopic[1] == "Network":      # These are status messages sent by gateways and nodes. Data in JSON format
            jPayload = json.loads(msg.payload)   # the payload should be JSON
            #print("Network status message received from {}".format(cTopic[2]))
            bUpdate = True
            # we need to ignore MQTT messages with a payload that has "Status": "Missing". Those are generated by us!
            if "Status" in jPayload:
                if jPayload["Status"] == "Missing":
                    print("Picked up a status = missing message")
                    bUpdate = False
            if bUpdate and node_validate(cTopic[2]):
                nd, created = Node.objects.get_or_create(nodeID = cTopic[2])
                nd.lastseen = timezone.make_aware(datetime.datetime.now(), timezone.get_current_timezone())
                nd.status = "Online"
                nd.save()

  


# ********************************************************************
def node_validate(inNode):
    """Function to validate node names and eliminate Klingon """
    # Only the characters below are accepted in nodeID's
    for c in inNode:
        if c not in 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890_-':
          print("Invalid char {}".format(c))
          return(False)
    if inNode == "sys-monitor":     # we don't monitor ourself!
        return(False)
    return(True)


#******************************************************************
def sys_monitor():
    """ The main program that sends updates to the MQTT system
    """

    print("Start function")

    #all_nodes = Node.objects.all()

    #for n in all_nodes:
    #    print(n)

    #The mqtt client is initialised
    client = mqtt.Client(client_id='sys_monitor2')

    #functions called by mqtt client
    client.on_connect = mqtt_on_connect
    client.on_message = mqtt_on_message

    # set up the local MQTT environment
    client.username_pw_set("aklciot", "iotiscool")
    client.connect("aws2.innovateauckland.nz", 1883, 60)

    # used to manage mqtt subscriptions
    client.loop_start()

    while True:
      time.sleep(1)


#********************************************************************
if __name__ == "__main__":
    sys_monitor()
